/**
 * Created by XXL on 2014-10-21.
 */

var fs = require("fs");
var request = require("request");
var crypto = require("crypto");



exports.cache = (function(){
    var sha1 = crypto.createHash('sha1');
    var md5 =  crypto.createHash('md5');
    var base_pic = JSON.parse(fs.readFileSync(__dirname+"/../../shared/appConfig")).pic_base;
    var roots =  JSON.parse(fs.readFileSync(__dirname+"/../../shared/appConfig")).pic_roots;
    var download = function(uri, filename, callback){
        request.head(uri, function(err, res, body){
            console.log('content-type:', res.headers['content-type']);
            console.log('content-length:', res.headers['content-length']);

            request(uri).pipe(fs.createWriteStream(filename)).on('close', callback);
        });
    };
    return function(uri){
        sha1.update(uri);
        md5.update(uri);
        var filename =  sha1.digest('hex') + md5.digest('hex');
        fs.exists(roots+filename,function(exist){
             if(!exist)
                 download(base_pic+uri,roots+filename, function(){
                     console.log('done');
                 });
        })

       sha1 = crypto.createHash('sha1');
        md5 =  crypto.createHash('md5');
        return filename;
    }
})()