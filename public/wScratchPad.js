!function(a){function b(b,c){this.$el=a(b),this.options=c,this.init=!1,this.enabled=!0,this._generate()}var c=window.navigator.userAgent.toLowerCase(),d=c.indexOf("android 4.2")>0;a.data=function(a,b,c){var b="data-"+b;return"undefined"==typeof c?a[b]:(a[b]=c,void 0)},a.removeData=function(a,b){for(var b in a)a[b]=null},a.fn.innerWidth=a.fn.width,a.fn.innerHeight=a.fn.height,b.prototype={_generate:function(){return a.support.canvas?(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),"static"===this.$el.css("position")&&this.$el.css("position","relative"),this.$img=a('<img src=""/>').attr("crossOrigin","").css({position:"absolute",width:"100%",height:"100%"}),this.$scratchpad=a(this.canvas).css({position:"absolute",width:"100%",height:"100%"}),this.$scratchpad.bindMobileEvents(),this.$scratchpad.mousedown(a.proxy(function(b){return this.enabled?(this.canvasOffset=a(this.canvas).offset(),this.scratch=!0,this._scratchFunc(b,"Down"),void 0):!0},this)).mousemove(a.proxy(function(a){this.scratch&&this._scratchFunc(a,"Move")},this)).mouseup(a.proxy(function(a){this.scratch&&(this.scratch=!1,this._scratchFunc(a,"Up"))},this)),this._setOptions(),this.$el.append(this.$img).append(this.$scratchpad),this.init=!0,this.reset(),void 0):(this.$el.append("Canvas is not supported in this browser."),!0)},reset:function(){var b,c=this,d=Math.ceil(this.$el.innerWidth()),e=Math.ceil(this.$el.innerHeight()),f=window.devicePixelRatio||1;this.pixels=d*e,this.$scratchpad.attr("width",d).attr("height",e),this.canvas.setAttribute("width",d*f),this.canvas.setAttribute("height",e*f),this.ctx.scale(f,f),this.pixels=d*f*e*f,this.$img.hide(),this.options.bg&&("#"===this.options.bg.charAt(0)?this.$el.css("backgroundColor",this.options.bg):(this.$el.css("backgroundColor",""),this.$img.attr("src",this.options.bg))),this.options.fg&&("#"===this.options.fg.charAt(0)?(this.ctx.fillStyle=this.options.fg,this.ctx.beginPath(),this.ctx.rect(0,0,d,e),this.ctx.fill(),this.$img.show()):(b=a(new Image).attr("src",this.options.fg),b[0].onload=function(){c.ctx.drawImage(b[0],0,0,d,e),c.$img.show()}))},clear:function(){this.ctx.clearRect(0,0,Math.ceil(this.$el.innerWidth()),Math.ceil(this.$el.innerHeight()))},enable:function(a){this.enabled=a===!0?!0:!1},destroy:function(){this.$el.children().remove(),a.removeData(this.$el,"wScratchPad")},_setOptions:function(){var a,b;for(a in this.options)this.options[a]=this.$el.attr("data-"+a)||this.options[a],b="set"+a.charAt(0).toUpperCase()+a.substring(1),this[b]&&this[b](this.options[a])},setBg:function(){this.init&&this.reset()},setFg:function(){this.setBg()},setCursor:function(a){this.$el.css("cursor",a)},_scratchFunc:function(b,c){var d=a.extend({},b);d.pageX=Math.floor(b.pageX-this.canvasOffset.left),d.pageY=Math.floor(b.pageY-this.canvasOffset.top),this["_scratch"+c](d),(this.options.realtime||"Up"===c)&&this.options["scratch"+c]&&this.options["scratch"+c].apply(this,[d,this._scratchPercent()])},_scratchPercent:function(){var a,b,c=0,d=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);for(a=0,b=d.data.length;b>a;a+=4)0===d.data[a]&&0===d.data[a+1]&&0===d.data[a+2]&&0===d.data[a+3]&&c++;return 100*(c/this.pixels)},_scratchDown:function(b){d&&a(this.canvas).css("margin-right","0px"==a(this.canvas).css("margin-right")?"1px":"0px"),this.ctx.globalCompositeOperation="destination-out",this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=this.options.size,this.ctx.beginPath(),this.ctx.arc(b.pageX,b.pageY,this.options.size/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(b.pageX,b.pageY)},_scratchMove:function(b){d&&a(this.canvas).css("margin-right","0px"==a(this.canvas).css("margin-right")?"1px":"0px"),this.ctx.lineTo(b.pageX,b.pageY),this.ctx.stroke()},_scratchUp:function(){d&&a(this.canvas).css("margin-right","0px"==a(this.canvas).css("margin-right")?"1px":"0px"),this.ctx.closePath()}},a.support.canvas=document.createElement("canvas").getContext,a.fn.wScratchPad=function(c,d){function e(){var d=a.data(this,"wScratchPad");return d||(d=new b(this,a.extend(!0,{},c)),a.data(this,"wScratchPad",d)),d}if("string"==typeof c){var f,g=[],h=(void 0!==d?"set":"get")+c.charAt(0).toUpperCase()+c.substring(1),i=function(){f.options[c]&&(f.options[c]=d),f[h]&&f[h].apply(f,[d])},j=function(){return f[h]?f[h].apply(f,[d]):f.options[c]?f.options[c]:void 0},k=function(){f=a.data(this,"wScratchPad"),f&&(f[c]?f[c].apply(f,[d]):void 0!==d?i():g.push(j()))};return this.each(k),g.length?1===g.length?g[0]:g:this}return c=a.extend({},a.fn.wScratchPad.defaults,c),this.each(e)},a.fn.wScratchPad.defaults={size:5,bg:"#cacaca",fg:"#6699ff",realtime:!0,scratchDown:null,scratchUp:null,scratchMove:null,cursor:"crosshair"},a.fn.bindMobileEvents=function(){a(this).on("touchstart touchmove touchend touchcancel",function(a){var b,c=a.changedTouches||a.originalEvent.targetTouches,d=c[0],e="";switch(a.type){case"touchstart":e="mousedown";break;case"touchmove":e="mousemove",a.preventDefault();break;case"touchend":e="mouseup";break;default:return}b=document.createEvent("MouseEvent"),b.initMouseEvent(e,!0,!0,window,1,d.screenX,d.screenY,d.clientX,d.clientY,!1,!1,!1,!1,0,null),d.target.dispatchEvent(b)})}}(Zepto);